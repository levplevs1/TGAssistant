from telebot.types import KeyboardButton, ReplyKeyboardMarkup

from app.bot.handlers import last_memory_message_id
from config import bot
from telebot import types
from database.load import get_user_database, add_user_database, get_memory_database, \
    get_memory_request_with_ids_filtered, get_counters_data


@bot.message_handler(commands=['start'])
def starter(message):

    user_id = message.from_user.id

    # –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π —Ñ–∞–π–ª
    user_data = get_user_database(user_id)

    if user_data is None:
        first_name = message.from_user.first_name
        last_name = message.from_user.last_name
        username = message.from_user.username

        add_user_database(user_id, username, first_name, last_name)

    keyboard = ReplyKeyboardMarkup(resize_keyboard=True, one_time_keyboard=True)
    keyboard.add(KeyboardButton("–í–æ—Ç —á—Ç–æ —è —É–º–µ—é"))

    bot.send_message(message.chat.id, """
<b>–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! üëã</b>

–Ø ‚Äî –≤–∞—à –ª–∏—á–Ω—ã–π —Ü–∏—Ñ—Ä–æ–≤–æ–π –ø–æ–º–æ—â–Ω–∏–∫ –ø–æ –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω—ã–º —É—Å–ª—É–≥–∞–º. –ì–æ—Ç–æ–≤ –ø–æ–º–æ—á—å –≤–∞–º —Å –ª—é–±—ã–º–∏ –≤–æ–ø—Ä–æ—Å–∞–º–∏, —Å–≤—è–∑–∞–Ω–Ω—ã–º–∏ —Å:

- üè† <b>–ñ–ö–•</b>: –û–ø–ª–∞—Ç–∞ —Å—á–µ—Ç—á–∏–∫–æ–≤, —Å–ø—Ä–∞–≤–∫–∏, —É—Å–ª—É–≥–∏ –∏ –º–Ω–æ–≥–æ–µ –¥—Ä—É–≥–æ–µ.
- üè• <b>–ó–¥—Ä–∞–≤–æ–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ</b>: –ó–∞–ø–∏—Å—å –∫ –≤—Ä–∞—á—É, –ø–æ–ª—É—á–µ–Ω–∏–µ —Å–ø—Ä–∞–≤–æ–∫, –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ª—å–≥–æ—Ç–∞—Ö.
- üéì <b>–û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ</b>: –ü–æ—Å—Ç—É–ø–∏—Ç—å –≤ —É—á–µ–±–Ω–æ–µ –∑–∞–≤–µ–¥–µ–Ω–∏–µ, –ø–æ–ª—É—á–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç—ã –∏ –¥—Ä—É–≥—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é.
- üöó <b>–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç</b>: –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞, –ø–æ–ª—É—á–µ–Ω–∏–µ –≤–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏—Ö –ø—Ä–∞–≤, –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —à—Ç—Ä–∞—Ñ–∞—Ö.

---

üí° <b>–ü—Ä–∏–º–µ—Ä—ã –∑–∞–ø—Ä–æ—Å–æ–≤:</b>
- "–ö–∞–∫ –∑–∞–ø–∏—Å–∞—Ç—å—Å—è –∫ –≤—Ä–∞—á—É —á–µ—Ä–µ–∑ –ø–æ—Ä—Ç–∞–ª –≥–æ—Å—É—Å–ª—É–≥?"
- "–û–ø–ª–∞—Ç–∏ —ç–ª–µ–∫—Ç—Ä–∏—á–µ—Å—Ç–≤–æ: –¥–µ–Ω—å 1253, –Ω–æ—á—å 842."
- "–ö–∞–∫–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã –Ω—É–∂–Ω—ã –¥–ª—è –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è –≤ –≤—É–∑?"
- "–ü–æ–∫–∞–∂–∏ –º–æ–∏ –ø–æ—Å–ª–µ–¥–Ω–∏–µ –ø–æ–∫–∞–∑–∞–Ω–∏—è —Å—á—ë—Ç—á–∏–∫–æ–≤."
- "/–∑–∞–ø–æ–º–Ω–∏ —è —Å—Ç—É–¥–µ–Ω—Ç 2 –∫—É—Ä—Å–∞."

---

<b>–ö–æ–º–∞–Ω–¥—ã, –∫–æ—Ç–æ—Ä—ã–µ –≤—ã –º–æ–∂–µ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:</b>
- <b>/menu</b> ‚Äî –≤—ã–±—Ä–∞—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é (–ñ–ö–•, –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç, –ó–¥—Ä–∞–≤–æ–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ, –û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ).
- <b>/memory</b> ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é, –∫–æ—Ç–æ—Ä—É—é —è –ø–æ–º–Ω—é –æ –≤–∞—Å.
- <b>/help</b> ‚Äî —É–∑–Ω–∞—Ç—å –±–æ–ª—å—à–µ –æ–±–æ –º–Ω–µ –∏ –∫–∞–∫ —è –º–æ–≥—É –ø–æ–º–æ—á—å.
- <b>/counters</b> ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å –ø–æ–∫–∞–∑–∞–Ω–∏—è –≤—Å–µ—Ö —Å—á–µ—Ç—á–∏–∫–æ–≤
–¢–∞–∫–∂–µ –≤ –±–æ—Ç–µ –¥–æ—Å—Ç—É–ø–Ω–∞ <b>—Ñ—É–Ω–∫—Ü–∏—è –æ–ø–ª–∞—Ç—ã —É—Å–ª—É–≥</b>! –í—ã –º–æ–∂–µ—Ç–µ –æ–ø–ª–∞—Ç–∏—Ç—å –ñ–ö–•, —ç–ª–µ–∫—Ç—Ä–∏—á–µ—Å—Ç–≤–æ, –≥–∞–∑ –∏ –º–Ω–æ–≥–æ–µ –¥—Ä—É–≥–æ–µ –ø—Ä—è–º–æ —á–µ—Ä–µ–∑ –±–æ—Ç–∞.

–ü—Ä–æ—Å—Ç–æ –≤—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É –∏–ª–∏ –Ω–∞–ø–∏—à–∏—Ç–µ –≤–∞—à –≤–æ–ø—Ä–æ—Å, –∏ —è –ø–æ—Å—Ç–∞—Ä–∞—é—Å—å –ø–æ–º–æ—á—å!

‚ú® <b>–í—Å–µ–≥–¥–∞ —Ä–∞–¥ –ø–æ–º–æ—á—å!</b>
""", parse_mode="HTML", reply_markup=keyboard)

@bot.message_handler(commands=['help'])
def help_command(message):
    bot.send_message(message.chat.id, """
<b>–ö–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è:</b>
- ‚ùì –ó–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å, –Ω–∞–ø—Ä–∏–º–µ—Ä: "–ö–∞–∫ –æ–ø–ª–∞—Ç–∏—Ç—å –≤–æ–¥—É?" –∏–ª–∏ "–ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å –ª—å–≥–æ—Ç—ã?"
- üìÇ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—ã: <b>/menu</b> –¥–ª—è –≤—ã–±–æ—Ä–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —É—Å–ª—É–≥ –∏–ª–∏ <b>/memory</b> –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∑–∞–ø–æ–º–Ω–µ–Ω–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏.
- üìù –ü–∏—à–∏—Ç–µ —Å–≤–æ–∏ –∑–∞–ø—Ä–æ—Å—ã –ø—Ä–æ—Å—Ç–æ –∏ –ø–æ–Ω—è—Ç–Ω–æ ‚Äî —è –ø–æ–º–æ–≥—É –Ω–∞–π—Ç–∏ –Ω—É–∂–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ.
- üìå –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /–∑–∞–ø–æ–º–Ω–∏ (—Ñ—Ä–∞–∑–∞) —á—Ç–æ –±—ã —è –∑–∞–ø–æ–º–Ω–∏–ª –≤–∞–∂–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é 
- üî¢ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É /counters —á—Ç–æ –±—ã –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ø–æ–∫–∞–∑–∞–Ω–∏—è —Å—á–µ—Ç—á–∏–∫–æ–≤

–ï—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ —Å–º–µ–Ω–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—è –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É <b>/menu</b>
""", parse_mode="HTML")

@bot.message_handler(commands=['memory'])
def memory_command(message):
    user_id = message.from_user.id
    # –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –ë–î
    # –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    memory = get_memory_request_with_ids_filtered(user_id)#!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
    memory_markup = types.InlineKeyboardMarkup()

    for key, id_memory in memory.items():
        memory_markup.add(types.InlineKeyboardButton(key.replace("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ø—Ä–æ—Å–∏–ª –∑–∞–ø–æ–º–Ω–∏—Ç—å:","", 1), callback_data=f'{id_memory}'))

    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –ø–∞–º—è—Ç—å—é –≤ –≤–∏–¥–µ –∫–Ω–æ–ø–æ–∫ –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –µ–≥–æ ID
    sent_message = bot.send_message(message.chat.id, "–í–æ—Ç —á—Ç–æ –º—ã –æ –≤–∞—Å –ø–æ–º–Ω–∏–º:", reply_markup=memory_markup)
    last_memory_message_id[user_id] = sent_message.message_id

@bot.message_handler(commands=['counters'])
def memory_command(message):
    user_id = message.from_user.id
    data = get_counters_data(user_id)

    text = '–ü–æ–∫–∞–∑–∞—Ç–µ–ª–∏ —Å—á–µ—Ç—á–∏–∫–æ–≤:\n'

    for key, value in data.items():
        if key == '–≥–∞–∑':
            key = '–ì–∞–∑'
            if value is not None:
                text += f"{key}: {value}\n"
            else:
                text += f"{key}: –ù–µ—É–∫–∞–∑–∞–Ω–Ω–æ\n"
        elif key == "–Ω–æ—á—å":
            key = '–ù–æ—á—å'
            if value is not None:
                text += f"{key}: {value}\n"
            else:
                text += f"{key}: –ù–µ—É–∫–∞–∑–∞–Ω–Ω–æ\n"
        elif key == "–¥–µ–Ω—å":
            key = '–î–µ–Ω—å'
            if value is not None:
                text += f"{key}: {value}\n"
            else:
                text += f"{key}: –ù–µ—É–∫–∞–∑–∞–Ω–Ω–æ\n"
        elif key == "–≥–æ—Ä—è—á–∞—è_–≤–æ–¥–∞":
            key = '–ì–æ—Ä—è—á–∞—è –≤–æ–¥–∞'
            if value is not None:
                text += f"{key}: {value}\n"
            else:
                text += f"{key}: –ù–µ—É–∫–∞–∑–∞–Ω–Ω–æ\n"
        elif key == "—Ö–æ–ª–æ–¥–Ω–∞—è_–≤–æ–¥–∞":
            key = '–•–æ–ª–æ–¥–Ω–∞—è –≤–æ–¥–∞'
            if value is not None:
                text += f"{key}: {value}\n"
            else:
                text += f"{key}: –ù–µ—É–∫–∞–∑–∞–Ω–Ω–æ\n"
        elif key == "–æ—Ç–æ–ø–ª–µ–Ω–∏–µ":
            key = "–û—Ç–æ–ø–ª–µ–Ω–∏–µ"
            if value is not None:
                text += f"{key}: {value}\n"
            else:
                text += f"{key}: –ù–µ—É–∫–∞–∑–∞–Ω–Ω–æ\n"

    bot.send_message(message.chat.id, text)